<!doctype html>
<head>
<meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" type="text/css" href="/static/style.css">
  <link rel="stylesheet" type="text/css" href="/static/pygments.css">

  <link rel="alternate" type="application/atom+xml" href="http://podoliaka.org/feed.xml" title="Roman Podoliaka's Blog">

  <title>Debugging of CPython processes with gdb</title>

  <meta name="author" content="Roman Podoliaka">
  

  

<body>

  <div class="header-wrapper">
  <header class="header">
    <img src="/static/logo.svg" alt="Logotype" class="logo">
    <a href="/" class="title">Roman Podoliaka's Blog</a>

    <nav>
      <a href="/about">about</a><a href="/talks">talks</a><a href="https://www.dropbox.com/s/j8n1yd86dn00a41/cv.pdf?dl=1">CV</a><a href="/feed.xml">feed</a>
    </nav>
  </header>
  </div> <!-- /.header-wrapper -->

  <div class="content-wrapper">
  <div id="content">
    
<article>
  <header>
    <h1>Debugging of CPython processes with gdb</h1>

    <div class="meta">
    
written by Roman Podoliaka on

<time datetime="2016-04-10T00:00:00+00:00">
  April 10, 2016
</time>





    </div>
  </header>

  <p><a href="https://docs.python.org/3.5/library/pdb.html">pdb</a> has been, is and probably always will be the bread and butter of Python
programmers, when they need to find the root cause of a problem in their
applications, as it's a built-in and easy to use debugger. But there are cases,
when <code>pdb</code> can't help you, e.g. if your app has got stuck somewhere, and you
need to attach to a running process to find out why, without restarting it.
This is where <a href="https://www.gnu.org/software/gdb/">gdb</a> shines.</p>
<h2>Why gdb?</h2>
<p><code>gdb</code> is a general purpose debugger, that is mostly used for debugging of C and
C++ applications (although it actually supports Ada, Objective-C, Pascal and more).</p>
<p>There are different reasons why a Python programmer would be interested in <code>gdb</code>
for debugging:</p>
<ul>
<li>
<p><code>gdb</code> allows one to attach to a running process without starting an app
in debug mode or modifying the app code in some way first (e.g. putting
something like <code>import rpdb; rpdb.set_trace()</code> into the code)</p>
</li>
<li>
<p><code>gdb</code> allows one to take a <a href="https://en.wikipedia.org/wiki/Core_dump">core dump</a> of a process and analyze it later.
This is useful, when you don't want to stop the process for the duration of time,
while you are introspecting its state, as well as when you do <a href="https://en.wikipedia.org/wiki/Debugging#Techniques">post-mortem</a>
debugging of a process that has already failed (e.g. <a href="https://www.freedesktop.org/software/systemd/man/systemd-coredump.html">crashed</a> with a
segmentation fault)</p>
</li>
<li>
<p>most debuggers available for Python (notable exceptions are <a href="http://winpdb.org/">winpdb</a> and <a href="https://github.com/fabioz/PyDev.Debugger">pydevd</a>)
do not support switching between threads of the application being debugged. <code>gdb</code>
allows that, as well as debugging of threads created by non-Python code (e.g. in some
native library used)</p>
</li>
</ul>
<h2>Debugging of interpreted languages</h2>
<p>So what makes Python special when using <code>gdb</code>?</p>
<p>In contradistinction to programming languages like C or C++, Python code is not
compiled into a native binary for a target platform. Instead there is an
interpreter (e.g.  <a href="https://en.wikipedia.org/wiki/CPython">CPython</a>, the reference implementation of Python), which
executes compiled <a href="http://security.coverity.com/blog/2014/Nov/understanding-python-bytecode.html">byte-code</a>.</p>
<p>This effectively means, that when you attach to a Python process with <code>gdb</code>,
you'll debug the interpreter instance and introspect the process state at the
interpreter level, not the application level: i.e. you will see functions and
variables of the interpreter, not of your app.</p>
<p>To give you an example, let's take a look at a <code>gdb</code> backtrace of a CPython
(the most popular Python interpreter) process:</p>
<div class="codehilite"><pre><span></span><code>#0  0x00007fcce9b2faf3 in __epoll_wait_nocancel () at ../sysdeps/unix/syscall-template.S:81
#1  0x0000000000435ef8 in pyepoll_poll (self=0x7fccdf54f240, args=&lt;optimized out&gt;, kwds=&lt;optimized out&gt;) at ../Modules/selectmodule.c:1034
#2  0x000000000049968d in call_function (oparg=&lt;optimized out&gt;, pp_stack=0x7ffc20d7bfb0) at ../Python/ceval.c:4020
#3  PyEval_EvalFrameEx () at ../Python/ceval.c:2666
#4  0x0000000000499ef2 in fast_function () at ../Python/ceval.c:4106
#5  call_function () at ../Python/ceval.c:4041
#6  PyEval_EvalFrameEx () at ../Python/ceval.c:2666
</code></pre></div>

<p>and one obtained by the means of <code>traceback.extract_stack()</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">python2</span><span class="m m-Double">.7</span><span class="o">/</span><span class="nx">dist</span><span class="o">-</span><span class="nx">packages</span><span class="o">/</span><span class="nx">eventlet</span><span class="o">/</span><span class="nx">greenpool</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">82</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">_spawn_n_impl</span>
<span class="w">    </span><span class="err">`</span><span class="nx">func</span><span class="p">(</span><span class="o">*</span><span class="nx">args</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="nx">kwargs</span><span class="p">)</span><span class="err">`</span>

<span class="o">/</span><span class="nx">opt</span><span class="o">/</span><span class="nx">stack</span><span class="o">/</span><span class="nx">neutron</span><span class="o">/</span><span class="nx">neutron</span><span class="o">/</span><span class="nx">agent</span><span class="o">/</span><span class="nx">l3</span><span class="o">/</span><span class="nx">agent</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">461</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">_process_router_update</span>
<span class="w">    </span><span class="err">`</span><span class="k">for</span><span class="w"> </span><span class="nx">rp</span><span class="p">,</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">each_update_to_next_router</span><span class="p">():</span><span class="err">`</span>

<span class="o">/</span><span class="nx">opt</span><span class="o">/</span><span class="nx">stack</span><span class="o">/</span><span class="nx">neutron</span><span class="o">/</span><span class="nx">neutron</span><span class="o">/</span><span class="nx">agent</span><span class="o">/</span><span class="nx">l3</span><span class="o">/</span><span class="nx">router_processing_queue</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">154</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">each_update_to_next_router</span>
<span class="w">    </span><span class="err">`</span><span class="nx">next_update</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">_queue</span><span class="p">.</span><span class="nx">get</span><span class="p">()</span><span class="err">`</span>

<span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">python2</span><span class="m m-Double">.7</span><span class="o">/</span><span class="nx">dist</span><span class="o">-</span><span class="nx">packages</span><span class="o">/</span><span class="nx">eventlet</span><span class="o">/</span><span class="nx">queue</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">313</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">get</span>
<span class="w">    </span><span class="err">`</span><span class="k">return</span><span class="w"> </span><span class="nx">waiter</span><span class="p">.</span><span class="nx">wait</span><span class="p">()</span><span class="err">`</span>

<span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">python2</span><span class="m m-Double">.7</span><span class="o">/</span><span class="nx">dist</span><span class="o">-</span><span class="nx">packages</span><span class="o">/</span><span class="nx">eventlet</span><span class="o">/</span><span class="nx">queue</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">141</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">wait</span>
<span class="w">   </span><span class="err">`</span><span class="k">return</span><span class="w"> </span><span class="nx">get_hub</span><span class="p">().</span><span class="nx">switch</span><span class="p">()</span><span class="err">`</span>

<span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">python2</span><span class="m m-Double">.7</span><span class="o">/</span><span class="nx">dist</span><span class="o">-</span><span class="nx">packages</span><span class="o">/</span><span class="nx">eventlet</span><span class="o">/</span><span class="nx">hubs</span><span class="o">/</span><span class="nx">hub</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">294</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">switch</span>
<span class="w">    </span><span class="err">`</span><span class="k">return</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">greenlet</span><span class="p">.</span><span class="nx">switch</span><span class="p">()</span><span class="err">`</span>
</code></pre></div>

<p>As is, the former is of little help, when you are trying to find a problem
in your Python code, and all you see is the current state of the interpreter
itself.</p>
<p>However, <a href="https://docs.python.org/2/c-api/veryhigh.html#c.PyEval_EvalFrameEx">PyEval_EvalFrameEx</a> looks interesting: it's a function of CPython,
which executes bytecode of Python application level functions and, thus,
has access to their state - the very state we are usually interested in.</p>
<h2>gdb and Python</h2>
<p>Search results for <code>"gdb debug python"</code> can be confusing. The thing is, that starting
from <code>gdb</code> version 7 it's been possible to <a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Python.html#Python">extend</a> the debugger with Python code, e.g.
in order to provide visualisations for C++ <a href="https://sourceware.org/gdb/wiki/STLSupport">STL</a> types, which is much easier to implement
in Python rather than in the built-in <a href="http://www.ibm.com/developerworks/aix/library/au-gdb.html">macro</a> language.</p>
<p>In order to be able to debug CPython processes and introspect the application level state,
the interpreter developers decided to extend <code>gdb</code> and wrote a <a href="https://github.com/python/cpython/blob/master/Tools/gdb/libpython.py">script</a> for that in... Python,
of course!</p>
<p>So it's two different, but related things:</p>
<ul>
<li><code>gdb</code> versions 7+ are extendable with Python modules</li>
<li>there's a Python <code>gdb</code> extension for debugging of CPython processes</li>
</ul>
<h2>Debugging Python with gdb 101</h2>
<p>First of all, you need to install <code>gdb</code>:</p>
<div class="codehilite"><pre><span></span><code># apt-get install gdb
</code></pre></div>

<p>or</p>
<div class="codehilite"><pre><span></span><code># yum install gdb
</code></pre></div>

<p>depending on the Linux distro you are using.</p>
<p>The next step is to install <a href="http://www.tutorialspoint.com/gnu_debugger/gdb_debugging_symbols.htm">debugging symbols</a> for the CPython build you have:</p>
<div class="codehilite"><pre><span></span><code># apt-get install python-dbg
</code></pre></div>

<p>or</p>
<div class="codehilite"><pre><span></span><code># yum install python-debuginfo
</code></pre></div>

<p>Some Linux distros like CentOS or RHEL ship debugging symbols <a href="http://debuginfo.centos.org/">separately</a> from
all other packages and recommend to install those like:</p>
<div class="codehilite"><pre><span></span><code># debuginfo-install python
</code></pre></div>

<p>The installed debugging symbols will be used by the CPython <a href="https://github.com/python/cpython/blob/master/Tools/gdb/libpython.py">script</a> for <code>gdb</code>
in order to analyze the <code>PyEval_EvalFrameEx</code> frames (a frame essentially is a
function call and the associated state in a form of local variables and CPU
registers, etc) and map those to application level functions in your code.</p>
<p>Without debugging symbols it's much harder to do - <code>gdb</code> allows you to
manipulate the process memory in any way you want, but you can't easily
understand what data structures reside in what memory areas.</p>
<p>After all preparatory steps have been completed, you can give <code>gdb</code> a try. E.g.
in order to attach to a running CPython process, do:</p>
<div class="codehilite"><pre><span></span><code>gdb /usr/bin/python -p $PID
</code></pre></div>

<p>At this point you can get an application level backtrace for the current
thread (note that some frames are "missing" - this is expected, as <code>gdb</code>
counts all the interpreter level frames and only some of those are calls
in application level code - <code>PyEval_EvalFrameEx</code> ones):</p>
<div class="codehilite"><pre><span></span><code><span class="ss">(</span><span class="nv">gdb</span><span class="ss">)</span><span class="w"> </span><span class="nv">py</span><span class="o">-</span><span class="nv">bt</span>

<span class="sc">#4</span><span class="w"> </span><span class="nv">Frame</span><span class="w"> </span><span class="mi">0</span><span class="nv">x1b7da60</span>,<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">python2</span>.<span class="mi">7</span><span class="o">/</span><span class="nv">sched</span>.<span class="nv">py</span>,<span class="w"> </span><span class="nv">line</span><span class="w"> </span><span class="mi">111</span>,<span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">run</span><span class="w"> </span><span class="ss">(</span><span class="nv">self</span><span class="o">=&lt;</span><span class="nv">scheduler</span><span class="ss">(</span><span class="nv">timefunc</span><span class="o">=&lt;</span><span class="nv">built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="nv">time</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">delayfunc</span><span class="o">=&lt;</span><span class="nv">built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="nv">sleep</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">_queue</span><span class="o">=</span>[<span class="o">&lt;</span><span class="nv">Event</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">remote</span><span class="w"> </span><span class="mi">0</span><span class="nv">x7fe1f8c74a10</span><span class="o">&gt;</span>]<span class="ss">)</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">remote</span><span class="w"> </span><span class="mi">0</span><span class="nv">x7fe1fa086758</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">q</span><span class="o">=</span>[...],<span class="w"> </span><span class="nv">delayfunc</span><span class="o">=&lt;</span><span class="nv">built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="nv">sleep</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">timefunc</span><span class="o">=&lt;</span><span class="nv">built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="nv">time</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">pop</span><span class="o">=&lt;</span><span class="nv">built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="nv">heappop</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">time</span><span class="o">=&lt;</span><span class="nv">float</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">remote</span><span class="w"> </span><span class="mi">0</span><span class="nv">x1a0a400</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">priority</span><span class="o">=</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">action</span><span class="o">=&lt;</span><span class="nv">function</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">remote</span><span class="w"> </span><span class="mi">0</span><span class="nv">x7fe1fa083aa0</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">argument</span><span class="o">=</span><span class="ss">(</span><span class="mi">171657</span>,<span class="ss">)</span>,<span class="w"> </span><span class="nv">checked_event</span><span class="o">=&lt;</span>...<span class="o">&gt;</span>,<span class="w"> </span><span class="nv">now</span><span class="o">=&lt;</span><span class="nv">float</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">remote</span><span class="w"> </span><span class="mi">0</span><span class="nv">x1b8ec58</span><span class="o">&gt;</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">delayfunc</span><span class="ss">(</span><span class="nv">time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">now</span><span class="ss">)</span>
<span class="sc">#7</span><span class="w"> </span><span class="nv">Frame</span><span class="w"> </span><span class="mi">0</span><span class="nv">x1b87e90</span>,<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">dstat</span>,<span class="w"> </span><span class="nv">line</span><span class="w"> </span><span class="mi">2416</span>,<span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">main</span><span class="w"> </span><span class="ss">(</span><span class="nv">interval</span><span class="o">=</span><span class="mi">1</span>,<span class="w"> </span><span class="nv">user</span><span class="o">=</span><span class="s1">&#39;ubuntu&#39;</span>,<span class="w"> </span><span class="nv">hostname</span><span class="o">=</span><span class="s1">&#39;rpodolyaka-devstack&#39;</span>,<span class="w"> </span><span class="nv">key</span><span class="o">=</span><span class="s1">&#39;unit_hi&#39;</span>,<span class="w"> </span><span class="nv">linewidth</span><span class="o">=</span><span class="mi">150</span>,<span class="w"> </span><span class="nv">plugin</span><span class="o">=</span><span class="s1">&#39;page&#39;</span>,<span class="w"> </span><span class="nv">mods</span><span class="o">=</span><span class="ss">(</span><span class="s1">&#39;page&#39;</span>,<span class="w"> </span><span class="s1">&#39;page24&#39;</span><span class="ss">)</span>,<span class="w"> </span><span class="nv">mod</span><span class="o">=</span><span class="s1">&#39;page&#39;</span>,<span class="w"> </span><span class="nv">pluginfile</span><span class="o">=</span><span class="s1">&#39;dstat_page&#39;</span>,<span class="w"> </span><span class="nv">scheduler</span><span class="o">=&lt;</span><span class="nv">scheduler</span><span class="ss">(</span><span class="nv">timefunc</span><span class="o">=&lt;</span><span class="nv">built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="nv">time</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">delayfunc</span><span class="o">=&lt;</span><span class="nv">built</span><span class="o">-</span><span class="nv">in</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="nv">sleep</span><span class="o">&gt;</span>,<span class="w"> </span><span class="nv">_queue</span><span class="o">=</span>[<span class="o">&lt;</span><span class="nv">Event</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">remote</span><span class="w"> </span><span class="mi">0</span><span class="nv">x7fe1f8c74a10</span><span class="o">&gt;</span>]<span class="ss">)</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">remote</span><span class="w"> </span><span class="mi">0</span><span class="nv">x7fe1fa086758</span><span class="o">&gt;</span><span class="ss">)</span>
<span class="w">    </span><span class="nv">scheduler</span>.<span class="nv">run</span><span class="ss">()</span>
<span class="sc">#11</span><span class="w"> </span><span class="nv">Frame</span><span class="w"> </span><span class="mi">0</span><span class="nv">x7fe1fa0bc5c0</span>,<span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">dstat</span>,<span class="w"> </span><span class="nv">line</span><span class="w"> </span><span class="mi">2554</span>,<span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="o">&lt;</span><span class="nv">module</span><span class="o">&gt;</span><span class="w"> </span><span class="ss">()</span>
<span class="w">    </span><span class="nv">main</span><span class="ss">()</span>
</code></pre></div>

<p>or find out what exact line of the application code is currently being executed:</p>
<div class="codehilite"><pre><span></span><code><span class="ss">(</span><span class="nv">gdb</span><span class="ss">)</span><span class="w"> </span><span class="nv">py</span><span class="o">-</span><span class="nv">list</span>

<span class="w"> </span><span class="mi">106</span><span class="w">            </span><span class="nv">pop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">heapq</span>.<span class="nv">heappop</span>
<span class="w"> </span><span class="mi">107</span><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="nv">q</span>:
<span class="w"> </span><span class="mi">108</span><span class="w">                </span><span class="nv">time</span>,<span class="w"> </span><span class="nv">priority</span>,<span class="w"> </span><span class="nv">action</span>,<span class="w"> </span><span class="nv">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">checked_event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>[<span class="mi">0</span>]
<span class="w"> </span><span class="mi">109</span><span class="w">                </span><span class="nv">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">timefunc</span><span class="ss">()</span>
<span class="w"> </span><span class="mi">110</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nv">now</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nv">time</span>:
<span class="o">&gt;</span><span class="mi">111</span><span class="w">                    </span><span class="nv">delayfunc</span><span class="ss">(</span><span class="nv">time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">now</span><span class="ss">)</span>
<span class="w"> </span><span class="mi">112</span><span class="w">                </span><span class="k">else</span>:
<span class="w"> </span><span class="mi">113</span><span class="w">                    </span><span class="nv">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">pop</span><span class="ss">(</span><span class="nv">q</span><span class="ss">)</span>
<span class="w"> </span><span class="mi">114</span><span class="w">                    </span>#<span class="w"> </span><span class="nv">Verify</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">event</span><span class="w"> </span><span class="nv">was</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">removed</span><span class="w"> </span><span class="nv">or</span><span class="w"> </span><span class="nv">altered</span>
<span class="w"> </span><span class="mi">115</span><span class="w">                    </span>#<span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">another</span><span class="w"> </span><span class="nv">thread</span><span class="w"> </span><span class="nv">after</span><span class="w"> </span><span class="nv">we</span><span class="w"> </span><span class="nv">last</span><span class="w"> </span><span class="nv">looked</span><span class="w"> </span><span class="nv">at</span><span class="w"> </span><span class="nv">q</span>[<span class="mi">0</span>].
<span class="w"> </span><span class="mi">116</span><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nv">event</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">checked_event</span>:
</code></pre></div>

<p>or look at values of local variables:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">py</span><span class="o">-</span><span class="n">locals</span>

<span class="bp">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">scheduler</span><span class="p">(</span><span class="n">timefunc</span><span class="o">=&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">time</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">delayfunc</span><span class="o">=&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">sleep</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">_queue</span><span class="o">=</span><span class="p">[</span><span class="o">&lt;</span><span class="n">Event</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="mh">0x7fe1f8c74a10</span><span class="o">&gt;</span><span class="p">])</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="mh">0x7fe1fa086758</span><span class="o">&gt;</span>
<span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&lt;</span><span class="n">Event</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="mh">0x7fe1f8c74a10</span><span class="o">&gt;</span><span class="p">]</span>
<span class="n">delayfunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">sleep</span><span class="o">&gt;</span>
<span class="n">timefunc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">time</span><span class="o">&gt;</span>
<span class="n">pop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">built</span><span class="o">-</span><span class="ow">in</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">heappop</span><span class="o">&gt;</span>
<span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="nb nb-Type">float</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="mh">0x1a0a400</span><span class="o">&gt;</span>
<span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">function</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="mh">0x7fe1fa083aa0</span><span class="o">&gt;</span>
<span class="n">argument</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">171657</span><span class="p">,)</span>
<span class="n">checked_event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Event</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="mh">0x7fe1f8c74a10</span><span class="o">&gt;</span>
<span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="nb nb-Type">float</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="mh">0x1b8ec58</span><span class="o">&gt;</span>
</code></pre></div>

<p>There are more <code>py-</code> commands provided by the CPython <a href="https://github.com/python/cpython/blob/master/Tools/gdb/libpython.py">script</a> for <code>gdb</code>.
Check out the debugging <a href="https://docs.python.org/devguide/gdb.html">guide</a> for details.</p>
<h2>Gotchas</h2>
<p>Although the described technique should work out-of-box, there are a few known
gotchas.</p>
<h2>python-dbg</h2>
<p>The <code>python-dbg</code> package in Debian and Ubuntu will not only install the
debugging symbols for <code>python</code> (which are stripped at the package build time
to save disk space), but also provide an additional CPython binary
<code>python-dbg</code>.</p>
<p>The latter essentially is a separate build of CPython (with <code>--with-pydebug</code> flag
passed to <code>./configure</code>) with many run-time checks.  Generally, you don't want
to use <code>python-dbg</code> in production, as it can be (much) slower than <code>python</code>,
e.g.:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;print(sum(range(1, 1000000)))&quot;</span>
<span class="m">499999500000</span>

real<span class="w">    </span>0m0.096s
user<span class="w">    </span>0m0.057s
sys<span class="w"> </span>0m0.030s

$<span class="w"> </span><span class="nb">time</span><span class="w"> </span>python-dbg<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;print(sum(range(1, 1000000)))&quot;</span>
<span class="m">499999500000</span>
<span class="o">[</span><span class="m">18318</span><span class="w"> </span>refs<span class="o">]</span>

real<span class="w">    </span>0m0.237s
user<span class="w">    </span>0m0.197s
sys<span class="w"> </span>0m0.016s
</code></pre></div>

<p>The good thing is, that you don't need to: it's still possible to debug
<code>python</code> executable by the means of <code>gdb</code>, as long as the corresponding debugging
symbols are installed.  So <code>python-dbg</code> just adds a bit more confusion to the
CPython/gdb story - you can safely ignore its existence.</p>
<h2>Build flags</h2>
<p>Some Linux distros build CPython passing the <code>-g0</code> or <code>-g1</code> <a href="https://gcc.gnu.org/onlinedocs/gcc/Debugging-Options.html">option</a> to <code>gcc</code>:
the former produces a binary without debugging information at all, and the latter
does not allow <code>gdb</code> to get information about local variables at runtime.</p>
<p>Both these options break the described workflow of debugging CPython processes
by the means of <code>gdb</code>. The solution is to rebuild CPython with <code>-g</code> or <code>-g2</code>
(<code>2</code> is the default value when <code>-g</code> is passed).</p>
<p>Fortunately, all current versions of the major Linux distros (Ubuntu Trusty/Xenial,
Debian Jessie, CentOS/RHEL 7) ship the "correctly" built CPython.</p>
<h2>Optimized out frames</h2>
<p>For introspection to work properly, it's crucial, that information about
<code>PyEval_EvalFrameEx</code> arguments is preserved for each call. Depending on the
<a href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html">optimization level</a> used in <code>gcc</code> when building CPython or the concrete
compiler version used, it's possible that this information will be lost at
runtime (especially with aggressive optimizations enabled by <code>-O3</code>). In this
case <code>gdb</code> will show you something like:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">bt</span>

<span class="err">#</span><span class="mi">0</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0007</span><span class="nx">fdf3ca31be3</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">__select_nocancel</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">sysdeps</span><span class="o">/</span><span class="nx">unix</span><span class="o">/</span><span class="nx">syscall</span><span class="o">-</span><span class="nx">template</span><span class="p">.</span><span class="nx">S</span><span class="p">:</span><span class="mi">84</span>
<span class="err">#</span><span class="mi">1</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000005</span><span class="nx">d1da4</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">pysleep</span><span class="w"> </span><span class="p">(</span><span class="nx">secs</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Modules</span><span class="o">/</span><span class="nx">timemodule</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">1408</span>
<span class="err">#</span><span class="mi">2</span><span class="w">  </span><span class="nx">time_sleep</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Modules</span><span class="o">/</span><span class="nx">timemodule</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">231</span>
<span class="err">#</span><span class="mi">3</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">f5465</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">call_function</span><span class="w"> </span><span class="p">(</span><span class="nx">oparg</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">fff62b184c0</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4637</span>
<span class="err">#</span><span class="mi">4</span><span class="w">  </span><span class="nx">PyEval_EvalFrameEx</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">3185</span>
<span class="err">#</span><span class="mi">5</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">f5194</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">fast_function</span><span class="w"> </span><span class="p">(</span><span class="nx">nk</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">na</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">n</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">fff62b185c0</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">func</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4750</span>
<span class="err">#</span><span class="mi">6</span><span class="w">  </span><span class="nx">call_function</span><span class="w"> </span><span class="p">(</span><span class="nx">oparg</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">fff62b185c0</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4677</span>
<span class="err">#</span><span class="mi">7</span><span class="w">  </span><span class="nx">PyEval_EvalFrameEx</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">3185</span>
<span class="err">#</span><span class="mi">8</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">f5194</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">fast_function</span><span class="w"> </span><span class="p">(</span><span class="nx">nk</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">na</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">n</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">fff62b186c0</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">func</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4750</span>
<span class="err">#</span><span class="mi">9</span><span class="w">  </span><span class="nx">call_function</span><span class="w"> </span><span class="p">(</span><span class="nx">oparg</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">fff62b186c0</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4677</span>
<span class="err">#</span><span class="mi">10</span><span class="w"> </span><span class="nx">PyEval_EvalFrameEx</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">3185</span>
<span class="err">#</span><span class="mi">11</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000005</span><span class="nx">c5da8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">_PyEval_EvalCodeWithName</span><span class="p">.</span><span class="nx">lto_priv</span><span class="m m-Double">.1</span><span class="mi">326</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">3965</span>
<span class="err">#</span><span class="mi">12</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000005</span><span class="nx">e9d7f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyEval_EvalCodeEx</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">3986</span>
<span class="err">#</span><span class="mi">13</span><span class="w"> </span><span class="nx">PyEval_EvalCode</span><span class="w"> </span><span class="p">(</span><span class="nx">co</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">globals</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">locals</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">777</span>
<span class="err">#</span><span class="mi">14</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000005</span><span class="nx">fe3d2</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">run_mod</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">pythonrun</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">970</span>
<span class="err">#</span><span class="mi">15</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">00000000060057</span><span class="nx">a</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyRun_FileExFlags</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">pythonrun</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">923</span>
<span class="err">#</span><span class="mi">16</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">00000000060075</span><span class="nx">c</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyRun_SimpleFileExFlags</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">pythonrun</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">396</span>
<span class="err">#</span><span class="mi">17</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">00000000062</span><span class="nx">b870</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">run_file</span><span class="w"> </span><span class="p">(</span><span class="nx">p_cf</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">fff62b18920</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">=</span><span class="mh">0x1</span><span class="mi">733260</span><span class="w"> </span><span class="nx">L</span><span class="s">&quot;test2.py&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fp</span><span class="p">=</span><span class="mh">0x1</span><span class="mi">790190</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Modules</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">318</span>
<span class="err">#</span><span class="mi">18</span><span class="w"> </span><span class="nx">Py_Main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Modules</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">768</span>
<span class="err">#</span><span class="mi">19</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">cb8ef</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Programs</span><span class="o">/</span><span class="nx">python</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">69</span>
<span class="err">#</span><span class="mi">20</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0007</span><span class="nx">fdf3c970610</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">__libc_start_main</span><span class="w"> </span><span class="p">(</span><span class="nx">main</span><span class="p">=</span><span class="mh">0x4</span><span class="nx">cb810</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">main</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">argc</span><span class="p">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">argv</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">fff62b18b38</span><span class="p">,</span><span class="w"> </span><span class="nx">init</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">fini</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">rtld_fini</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">stack_end</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">fff62b18b28</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">libc</span><span class="o">-</span><span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">291</span>
<span class="err">#</span><span class="mi">21</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000005</span><span class="nx">c9df9</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">_start</span><span class="w"> </span><span class="p">()</span>

<span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">py</span><span class="o">-</span><span class="nx">bt</span>
<span class="nx">Traceback</span><span class="w"> </span><span class="p">(</span><span class="nx">most</span><span class="w"> </span><span class="nx">recent</span><span class="w"> </span><span class="nx">call</span><span class="w"> </span><span class="nx">first</span><span class="p">):</span>
<span class="w">  </span><span class="nx">File</span><span class="w"> </span><span class="s">&quot;test2.py&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">g</span>
<span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="w">  </span><span class="nx">File</span><span class="w"> </span><span class="s">&quot;test2.py&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">f</span>
<span class="w">    </span><span class="nx">g</span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="nx">frame</span><span class="w"> </span><span class="nx">information</span><span class="w"> </span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">)</span>
</code></pre></div>

<p>i.e. some application level frames will be available, some will not.
There is little you can do at this point, except for rebuilding CPython
with a lower optimization level, but that often is not an option for production
(not to mention the fact you'll be using a custom CPython build, not the
one provided by your Linux distro).</p>
<p><strong>Update</strong>: actually, there is something you could do. This "frame information optimized out"
message essentially tells you that gdb wasn't able to figure out the location of
<code>PyFrameObject</code> data structure in a given stack frame (DWARF debugging symbols
allow gdb to calculate addresses of local variables and function arguments). But
it has to be somewhere; otherwise CPython would not be able to execute your Python
code.</p>
<p>On x86-64 machines the obvious place to check is CPU registers: there are 16 general
purpose CPU registers, that compilers can use for storing the values of function
call arguments and local variables.</p>
<p>The following command prints the values of all CPU registers in the selected
stack frame:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="n">registers</span>
<span class="n">rax</span><span class="w">            </span><span class="mh">0</span><span class="n">xfffffffffffffdfe</span><span class="w">   </span><span class="o">-</span><span class="mh">514</span>
<span class="n">rbx</span><span class="w">            </span><span class="mh">0</span><span class="n">x7ffff7fd7c20</span><span class="w">   </span><span class="mh">140737353972768</span>
<span class="n">rcx</span><span class="w">            </span><span class="mh">0</span><span class="n">x7ffff7afaff7</span><span class="w">   </span><span class="mh">140737348874231</span>
<span class="n">rdx</span><span class="w">            </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">rsi</span><span class="w">            </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">rdi</span><span class="w">            </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">rbp</span><span class="w">            </span><span class="mh">0</span><span class="n">x7ffff7fd7d98</span><span class="w">   </span><span class="mh">0</span><span class="n">x7ffff7fd7d98</span>
<span class="n">rsp</span><span class="w">            </span><span class="mh">0</span><span class="n">x7fffffffe3c0</span><span class="w">   </span><span class="mh">0</span><span class="n">x7fffffffe3c0</span>
<span class="n">r8</span><span class="w">             </span><span class="mh">0</span><span class="n">x7fffffffe050</span><span class="w">   </span><span class="mh">140737488347216</span>
<span class="n">r9</span><span class="w">             </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">r10</span><span class="w">            </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">r11</span><span class="w">            </span><span class="mh">0</span><span class="n">x246</span><span class="w">    </span><span class="mh">582</span>
<span class="n">r12</span><span class="w">            </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">r13</span><span class="w">            </span><span class="mh">0</span><span class="n">x7ffff7fae050</span><span class="w">   </span><span class="mh">140737353801808</span>
<span class="n">r14</span><span class="w">            </span><span class="mh">0</span><span class="n">x7ffff7fae050</span><span class="w">   </span><span class="mh">140737353801808</span>
<span class="n">r15</span><span class="w">            </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">rip</span><span class="w">            </span><span class="mh">0</span><span class="n">x5555556468ca</span><span class="w">   </span><span class="mh">0</span><span class="n">x5555556468ca</span><span class="w"> </span><span class="o">&lt;</span><span class="n">PyEval_EvalCodeEx</span><span class="o">+</span><span class="mh">1754</span><span class="o">&gt;</span>
<span class="n">eflags</span><span class="w">         </span><span class="mh">0</span><span class="n">x246</span><span class="w">    </span><span class="p">[</span><span class="w"> </span><span class="n">PF</span><span class="w"> </span><span class="n">ZF</span><span class="w"> </span><span class="n">IF</span><span class="w"> </span><span class="p">]</span>
<span class="n">cs</span><span class="w">             </span><span class="mh">0</span><span class="n">x33</span><span class="w"> </span><span class="mh">51</span>
<span class="n">ss</span><span class="w">             </span><span class="mh">0</span><span class="n">x2b</span><span class="w"> </span><span class="mh">43</span>
<span class="n">ds</span><span class="w">             </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">es</span><span class="w">             </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">fs</span><span class="w">             </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
<span class="n">gs</span><span class="w">             </span><span class="mh">0</span><span class="n">x0</span><span class="w">  </span><span class="mh">0</span>
</code></pre></div>

<p>But these are just numbers. We need to help gdb put some meaning behind them.</p>
<p>Note, that some of the numbers above clearly look like memory addresses. We can ask
gdb to interpret the value of a CPU register as a pointer to some data type. We know,
that most of CPython runtime data structures are PyObject's, that store information
on the actual type internally (e.g. <code>-&gt;ob_type-&gt;tp_name</code> field contains a type
name encoded as a C-string).</p>
<p>So what we'll do is try to cast the value of each CPU register to <code>PyObject*</code> and
see if we can find anything useful:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="p">((</span><span class="nx">PyObject</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="err">$</span><span class="nx">rax</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">ob_type</span><span class="o">-&gt;</span><span class="nx">tp_name</span>
<span class="nx">Cannot</span><span class="w"> </span><span class="nx">access</span><span class="w"> </span><span class="nx">memory</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="mh">0xf</span><span class="nx">ffffffffffffe06</span>
</code></pre></div>

<p>If we give gdb a memory address, that does not actually point to a <code>PyObject</code> instance,
we'll get an error on pointer dereference.</p>
<p>There are only so many CPU registers to check.  And you can easily automate this search by the
means of a helper gdb command similar to:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">LocatePyFrameObject</span><span class="p">(</span><span class="n">gdb</span><span class="o">.</span><span class="n">Command</span><span class="p">):</span>
    <span class="s1">&#39;Locate the CPU register that contains the value of PyFrameObject* in the selected stack frame&#39;</span>

    <span class="n">REGISTERS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># x86-64 registers, that can be used for storing of local variables and function arguments</span>
        <span class="s1">&#39;rax&#39;</span><span class="p">,</span> <span class="s1">&#39;rbx&#39;</span><span class="p">,</span> <span class="s1">&#39;rcx&#39;</span><span class="p">,</span> <span class="s1">&#39;rdx&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rsi&#39;</span><span class="p">,</span> <span class="s1">&#39;rdi&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rbp&#39;</span><span class="p">,</span> <span class="s1">&#39;rsp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;r8&#39;</span><span class="p">,</span> <span class="s1">&#39;r9&#39;</span><span class="p">,</span> <span class="s1">&#39;r10&#39;</span><span class="p">,</span> <span class="s1">&#39;r11&#39;</span><span class="p">,</span> <span class="s1">&#39;r12&#39;</span><span class="p">,</span> <span class="s1">&#39;r13&#39;</span><span class="p">,</span> <span class="s1">&#39;r14&#39;</span><span class="p">,</span> <span class="s1">&#39;r15&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LocatePyFrameObject</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="s1">&#39;py-locate-frame&#39;</span><span class="p">,</span>
            <span class="n">gdb</span><span class="o">.</span><span class="n">COMMAND_DATA</span><span class="p">,</span>
            <span class="n">gdb</span><span class="o">.</span><span class="n">COMPLETE_NONE</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">from_tty</span><span class="p">):</span>
        <span class="n">gdb_type</span> <span class="o">=</span> <span class="n">PyObjectPtr</span><span class="o">.</span><span class="n">get_gdb_type</span><span class="p">()</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">selected_frame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">register</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">REGISTERS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">read_register</span><span class="p">(</span><span class="n">register</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">gdb_type</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;ob_type&#39;</span><span class="p">][</span><span class="s1">&#39;tp_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">string</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;frame&#39;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">register</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="n">gdb</span><span class="o">.</span><span class="n">MemoryError</span><span class="p">:</span>
                <span class="c1"># if either cast or pointer dereference fails, then it&#39;s not a valid PyFrameObjectPtr*</span>
                <span class="k">continue</span>

<span class="n">LocatePyFrameObject</span><span class="p">()</span>
</code></pre></div>

<p>E.g., my CPython build puts the pointer to <code>PyFrameObject</code> to the CPU register RBX:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">py</span><span class="o">-</span><span class="nx">locate</span><span class="o">-</span><span class="nx">frame</span>
<span class="nx">rbx</span>

<span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="p">((</span><span class="nx">PyObject</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="err">$</span><span class="nx">rbx</span><span class="p">)</span><span class="o">-&gt;</span><span class="nx">ob_type</span><span class="o">-&gt;</span><span class="nx">tp_name</span>
<span class="err">$</span><span class="mi">28</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mh">0x5</span><span class="mi">555557472</span><span class="nx">ef</span><span class="w"> </span><span class="s">&quot;frame&quot;</span>

<span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="p">(</span><span class="nx">PyFrameObject</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="err">$</span><span class="nx">rbx</span>
<span class="err">$</span><span class="mi">29</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Frame</span><span class="w"> </span><span class="mh">0x7</span><span class="nx">ffff7fd7c20</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">test2</span><span class="p">.</span><span class="nx">py</span><span class="p">,</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">module</span><span class="p">&gt;</span><span class="w"> </span><span class="p">()</span>

<span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">p</span><span class="w"> </span><span class="p">(</span><span class="nx">PyObject</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="err">$</span><span class="nx">rbx</span>
<span class="err">$</span><span class="mi">30</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Frame</span><span class="w"> </span><span class="mh">0x7</span><span class="nx">ffff7fd7c20</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="nx">test2</span><span class="p">.</span><span class="nx">py</span><span class="p">,</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">module</span><span class="p">&gt;</span><span class="w"> </span><span class="p">()</span>
</code></pre></div>

<p>Note, that the loaded <code>libpython-gdb.py</code> script provides pretty-printing for
<code>PyFrameObject</code> data structure, as well it's able to figure out a specific
type of a given <code>PyObject</code> automatically. So even if high-level commands
like <code>py-bt</code> don't work on such stack frames, you'll be able to get the
very same information by pointing gdb to the location of <code>PyFrameObject</code>
manually.</p>
<p>Of course, manually poking CPU registers and memory addresses is not pretty,
but it can be the only way of debugging "optimized out" frames.</p>
<h2>Virtual environments and custom CPython builds</h2>
<p>When a virtual environment is used, it may appear that the extension does not work:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">bt</span>

<span class="err">#</span><span class="mi">0</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0007</span><span class="nx">ff2df3d0be3</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">__select_nocancel</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">sysdeps</span><span class="o">/</span><span class="nx">unix</span><span class="o">/</span><span class="nx">syscall</span><span class="o">-</span><span class="nx">template</span><span class="p">.</span><span class="nx">S</span><span class="p">:</span><span class="mi">84</span>
<span class="err">#</span><span class="mi">1</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">000000000588</span><span class="nx">c4a</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="p">()</span>
<span class="err">#</span><span class="mi">2</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">bad9a</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyEval_EvalFrameEx</span><span class="w"> </span><span class="p">()</span>
<span class="err">#</span><span class="mi">3</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">bfd1f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyEval_EvalFrameEx</span><span class="w"> </span><span class="p">()</span>
<span class="err">#</span><span class="mi">4</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">bfd1f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyEval_EvalFrameEx</span><span class="w"> </span><span class="p">()</span>
<span class="err">#</span><span class="mi">5</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">b8556</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyEval_EvalCodeEx</span><span class="w"> </span><span class="p">()</span>
<span class="err">#</span><span class="mi">6</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">e91ef</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">??</span><span class="w"> </span><span class="p">()</span>
<span class="err">#</span><span class="mi">7</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">e3d92</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyRun_FileExFlags</span><span class="w"> </span><span class="p">()</span>
<span class="err">#</span><span class="mi">8</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">e2646</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyRun_SimpleFileExFlags</span><span class="w"> </span><span class="p">()</span>
<span class="err">#</span><span class="mi">9</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">000000000491</span><span class="nx">c23</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">Py_Main</span><span class="w"> </span><span class="p">()</span>
<span class="err">#</span><span class="mi">10</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0007</span><span class="nx">ff2df30f610</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">__libc_start_main</span><span class="w"> </span><span class="p">(</span><span class="nx">main</span><span class="p">=</span><span class="mh">0x4</span><span class="mi">91670</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">main</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">argc</span><span class="p">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">argv</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">ffc36f11cf8</span><span class="p">,</span><span class="w"> </span><span class="nx">init</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">fini</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">rtld_fini</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">stack_end</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">ffc36f11ce8</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">libc</span><span class="o">-</span><span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">291</span>
<span class="err">#</span><span class="mi">11</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">00000000049159</span><span class="nx">b</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">_start</span><span class="w"> </span><span class="p">()</span>

<span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">py</span><span class="o">-</span><span class="nx">bt</span>

<span class="nx">Undefined</span><span class="w"> </span><span class="nx">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;py-bt&quot;</span><span class="p">.</span><span class="w">  </span><span class="nx">Try</span><span class="w"> </span><span class="s">&quot;help&quot;</span><span class="p">.</span>
</code></pre></div>

<p><code>gdb</code> can still follow the CPython frames, but information on <code>PyEval_EvalCodeEx</code>
calls is not available.</p>
<p>If you scroll up the <code>gdb</code> output a bit, you'll see that <code>gdb</code> failed to find
the debugging symbols for <code>python</code> executable:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>gdb<span class="w"> </span>-p<span class="w"> </span><span class="m">2975</span>

GNU<span class="w"> </span>gdb<span class="w"> </span><span class="o">(</span>Debian<span class="w"> </span><span class="m">7</span>.10-1+b1<span class="o">)</span><span class="w"> </span><span class="m">7</span>.10
Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2015</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
License<span class="w"> </span>GPLv3+:<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>version<span class="w"> </span><span class="m">3</span><span class="w"> </span>or<span class="w"> </span>later<span class="w"> </span>&lt;http://gnu.org/licenses/gpl.html&gt;
This<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software:<span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>free<span class="w"> </span>to<span class="w"> </span>change<span class="w"> </span>and<span class="w"> </span>redistribute<span class="w"> </span>it.
There<span class="w"> </span>is<span class="w"> </span>NO<span class="w"> </span>WARRANTY,<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>extent<span class="w"> </span>permitted<span class="w"> </span>by<span class="w"> </span>law.<span class="w">  </span>Type<span class="w"> </span><span class="s2">&quot;show copying&quot;</span>
and<span class="w"> </span><span class="s2">&quot;show warranty&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>details.
This<span class="w"> </span>GDB<span class="w"> </span>was<span class="w"> </span>configured<span class="w"> </span>as<span class="w"> </span><span class="s2">&quot;x86_64-linux-gnu&quot;</span>.
Type<span class="w"> </span><span class="s2">&quot;show configuration&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>configuration<span class="w"> </span>details.
For<span class="w"> </span>bug<span class="w"> </span>reporting<span class="w"> </span>instructions,<span class="w"> </span>please<span class="w"> </span>see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find<span class="w"> </span>the<span class="w"> </span>GDB<span class="w"> </span>manual<span class="w"> </span>and<span class="w"> </span>other<span class="w"> </span>documentation<span class="w"> </span>resources<span class="w"> </span>online<span class="w"> </span>at:
&lt;http://www.gnu.org/software/gdb/documentation/&gt;.
For<span class="w"> </span>help,<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;help&quot;</span>.
Type<span class="w"> </span><span class="s2">&quot;apropos word&quot;</span><span class="w"> </span>to<span class="w"> </span>search<span class="w"> </span><span class="k">for</span><span class="w"> </span>commands<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span><span class="s2">&quot;word&quot;</span>.
Attaching<span class="w"> </span>to<span class="w"> </span>process<span class="w"> </span><span class="m">2975</span>
Reading<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>/home/rpodolyaka/workspace/venvs/default/bin/python2...<span class="o">(</span>no<span class="w"> </span>debugging<span class="w"> </span>symbols<span class="w"> </span>found<span class="o">)</span>...done.
</code></pre></div>

<p>How is a virtual environment any different? Why did not <code>gdb</code> find the debugging symbols?</p>
<p>First and foremost, the path to <code>python</code> executable is different. Note, that I
did not specify the executable file, when attaching to the process. In this
case <code>gdb</code> will take the executable file of the process (i.e. <code>/proc/$PID/exe</code>
value on Linux).</p>
<p>One of the ways to <a href="https://sourceware.org/gdb/onlinedocs/gdb/Separate-Debug-Files.html">separate</a> debugging symbols is to put those into a well-known
directory (default is <code>/usr/lib/debug/</code>, although it's configurable via
<code>debug-file-directory</code> option in <code>gdb</code>). In our case <code>gdb</code> tried to load
debugging symbols from <code>/usr/lib/debug/home/rpodolyaka/workspace/venvs/default/bin/python2</code> and,
obviously, did not find anything there.</p>
<p>The solution is simple - specify the executable under debug explicitly when
running <code>gdb</code>:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>gdb<span class="w"> </span>/usr/bin/python2.7<span class="w"> </span>-p<span class="w"> </span><span class="nv">$PID</span>
</code></pre></div>

<p>Thus, <code>gdb</code> will look for debugging symbols in the "right" place -
<code>/usr/lib/debug/usr/bin/python2.7</code>.</p>
<p>It's also worth mentioning, that it's possible that debugging symbols for a
particular executable are identified by a unique <code>build-id</code> value stored
in <a href="https://en.wikipedia.org/wiki/Executable_and_Linkable_Format">ELF</a> executable headers. E.g. CPython on my Debian machine:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>objdump<span class="w"> </span>-s<span class="w"> </span>-j<span class="w"> </span>.note.gnu.build-id<span class="w"> </span>/usr/bin/python2.7

/usr/bin/python2.7:<span class="w">     </span>file<span class="w"> </span>format<span class="w"> </span>elf64-x86-64

Contents<span class="w"> </span>of<span class="w"> </span>section<span class="w"> </span>.note.gnu.build-id:
<span class="w"> </span><span class="m">400274</span><span class="w"> </span><span class="m">04000000</span><span class="w"> </span><span class="m">14000000</span><span class="w"> </span><span class="m">03000000</span><span class="w"> </span>474e5500<span class="w">  </span>............GNU.
<span class="w"> </span><span class="m">400284</span><span class="w"> </span>8d04a3ae<span class="w"> </span>38521cb7<span class="w"> </span>c7928e4a<span class="w"> </span>7c8b1ed3<span class="w">  </span>....8R.....J<span class="p">|</span>...
<span class="w"> </span><span class="m">400294</span><span class="w"> </span>85e763e4
</code></pre></div>

<p>In this case <code>gdb</code> will look for debugging symbols using the <code>build-id</code> value:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>gdb<span class="w"> </span>/usr/bin/python2.7

GNU<span class="w"> </span>gdb<span class="w"> </span><span class="o">(</span>Debian<span class="w"> </span><span class="m">7</span>.10-1+b1<span class="o">)</span><span class="w"> </span><span class="m">7</span>.10
Copyright<span class="w"> </span><span class="o">(</span>C<span class="o">)</span><span class="w"> </span><span class="m">2015</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
License<span class="w"> </span>GPLv3+:<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>version<span class="w"> </span><span class="m">3</span><span class="w"> </span>or<span class="w"> </span>later<span class="w"> </span>&lt;http://gnu.org/licenses/gpl.html&gt;
This<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software:<span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>free<span class="w"> </span>to<span class="w"> </span>change<span class="w"> </span>and<span class="w"> </span>redistribute<span class="w"> </span>it.
There<span class="w"> </span>is<span class="w"> </span>NO<span class="w"> </span>WARRANTY,<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>extent<span class="w"> </span>permitted<span class="w"> </span>by<span class="w"> </span>law.<span class="w">  </span>Type<span class="w"> </span><span class="s2">&quot;show copying&quot;</span>
and<span class="w"> </span><span class="s2">&quot;show warranty&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>details.
This<span class="w"> </span>GDB<span class="w"> </span>was<span class="w"> </span>configured<span class="w"> </span>as<span class="w"> </span><span class="s2">&quot;x86_64-linux-gnu&quot;</span>.
Type<span class="w"> </span><span class="s2">&quot;show configuration&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>configuration<span class="w"> </span>details.
For<span class="w"> </span>bug<span class="w"> </span>reporting<span class="w"> </span>instructions,<span class="w"> </span>please<span class="w"> </span>see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find<span class="w"> </span>the<span class="w"> </span>GDB<span class="w"> </span>manual<span class="w"> </span>and<span class="w"> </span>other<span class="w"> </span>documentation<span class="w"> </span>resources<span class="w"> </span>online<span class="w"> </span>at:
&lt;http://www.gnu.org/software/gdb/documentation/&gt;.
For<span class="w"> </span>help,<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;help&quot;</span>.
Type<span class="w"> </span><span class="s2">&quot;apropos word&quot;</span><span class="w"> </span>to<span class="w"> </span>search<span class="w"> </span><span class="k">for</span><span class="w"> </span>commands<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span><span class="s2">&quot;word&quot;</span>...
Reading<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>/usr/bin/python2.7...Reading<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>/usr/lib/debug/.build-id/8d/04a3ae38521cb7c7928e4a7c8b1ed385e763e4.debug...done.
<span class="k">done</span>.
</code></pre></div>

<p>This has a nice implication - it no longer matters how the executable is called:
<code>virtualenv</code> just creates a copy of the specified interpreter executable, thus,
both executables - the one in <code>/usr/bin/</code> and the one in your virtual environment
will use the very same debugging symbols:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>gdb<span class="w"> </span>-p<span class="w"> </span><span class="m">11150</span>

GNU<span class="w"> </span>gdb<span class="w"> </span><span class="o">(</span>ebian<span class="w"> </span><span class="m">7</span>.10-1+b1<span class="o">)</span><span class="w"> </span><span class="m">7</span>.10
Copyright<span class="w"> </span><span class="o">()</span><span class="w"> </span><span class="m">2015</span><span class="w"> </span>Free<span class="w"> </span>Software<span class="w"> </span>Foundation,<span class="w"> </span>Inc.
License<span class="w"> </span>GPLv3+:<span class="w"> </span>GNU<span class="w"> </span>GPL<span class="w"> </span>version<span class="w"> </span><span class="m">3</span><span class="w"> </span>or<span class="w"> </span>later<span class="w"> </span>&lt;http://gnu.org/licenses/gpl.html&gt;
This<span class="w"> </span>is<span class="w"> </span>free<span class="w"> </span>software:<span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>free<span class="w"> </span>to<span class="w"> </span>change<span class="w"> </span>and<span class="w"> </span>redistribute<span class="w"> </span>it.
There<span class="w"> </span>is<span class="w"> </span>NO<span class="w"> </span>WARRANTY,<span class="w"> </span>to<span class="w"> </span>the<span class="w"> </span>extent<span class="w"> </span>permitted<span class="w"> </span>by<span class="w"> </span>law.<span class="w">  </span>Type<span class="w"> </span><span class="s2">&quot;how copying&quot;</span>
and<span class="w"> </span><span class="s2">&quot;how warranty&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>details.
This<span class="w"> </span>GDB<span class="w"> </span>was<span class="w"> </span>configured<span class="w"> </span>as<span class="w"> </span><span class="s2">&quot;86_64-linux-gnu&quot;</span>.
Type<span class="w"> </span><span class="s2">&quot;how configuration&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>configuration<span class="w"> </span>details.
For<span class="w"> </span>bug<span class="w"> </span>reporting<span class="w"> </span>instructions,<span class="w"> </span>please<span class="w"> </span>see:
&lt;http://www.gnu.org/software/gdb/bugs/&gt;.
Find<span class="w"> </span>the<span class="w"> </span>GDB<span class="w"> </span>manual<span class="w"> </span>and<span class="w"> </span>other<span class="w"> </span>documentation<span class="w"> </span>resources<span class="w"> </span>online<span class="w"> </span>at:
&lt;http://www.gnu.org/software/gdb/documentation/&gt;.
For<span class="w"> </span>help,<span class="w"> </span><span class="nb">type</span><span class="w"> </span><span class="s2">&quot;elp&quot;</span>.
Type<span class="w"> </span><span class="s2">&quot;propos word&quot;</span><span class="w"> </span>to<span class="w"> </span>search<span class="w"> </span><span class="k">for</span><span class="w"> </span>commands<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span><span class="s2">&quot;ord&quot;</span>.
Attaching<span class="w"> </span>to<span class="w"> </span>process<span class="w"> </span><span class="m">11150</span>
Reading<span class="w"> </span>symbols<span class="w"> </span>from<span class="w"> </span>/home/rpodolyaka/sandbox/testvenv/bin/python2.7...Reading<span class="w"> </span>symbols<span class="w"> </span>from
/usr/lib/debug/.build-id/8d/04a3ae38521cb7c7928e4a7c8b1ed385e763e4.debug...done.

$<span class="w"> </span>ls<span class="w"> </span>-la<span class="w"> </span>/proc/11150/exe
lrwxrwxrwx<span class="w"> </span><span class="m">1</span><span class="w"> </span>rpodolyaka<span class="w"> </span>rpodolyaka<span class="w"> </span><span class="m">0</span><span class="w"> </span>Apr<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">15</span>:18<span class="w"> </span>/proc/11150/exe<span class="w"> </span>-&gt;<span class="w"> </span>/home/rpodolyaka/sandbox/testvenv/bin/python2.7
</code></pre></div>

<p>The first problem is solved, <code>bt</code> output now looks much nicer, but <code>py-bt</code> command is still
undefined:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">bt</span>

<span class="err">#</span><span class="mi">0</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0007</span><span class="nx">f3e95083be3</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">__select_nocancel</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">sysdeps</span><span class="o">/</span><span class="nx">unix</span><span class="o">/</span><span class="nx">syscall</span><span class="o">-</span><span class="nx">template</span><span class="p">.</span><span class="nx">S</span><span class="p">:</span><span class="mi">84</span>
<span class="err">#</span><span class="mi">1</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">000000000594</span><span class="nx">a59</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">floatsleep</span><span class="w"> </span><span class="p">(</span><span class="nx">secs</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Modules</span><span class="o">/</span><span class="nx">timemodule</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">948</span>
<span class="err">#</span><span class="mi">2</span><span class="w">  </span><span class="nx">time_sleep</span><span class="p">.</span><span class="nx">lto_priv</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Modules</span><span class="o">/</span><span class="nx">timemodule</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">206</span>
<span class="err">#</span><span class="mi">3</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">c524a</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">call_function</span><span class="w"> </span><span class="p">(</span><span class="nx">oparg</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">ffefb5045b0</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4350</span>
<span class="err">#</span><span class="mi">4</span><span class="w">  </span><span class="nx">PyEval_EvalFrameEx</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">2987</span>
<span class="err">#</span><span class="mi">5</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">ca95f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">fast_function</span><span class="w"> </span><span class="p">(</span><span class="nx">nk</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">na</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">n</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">ffefb504700</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">func</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">f3e95f78c80</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4435</span>
<span class="err">#</span><span class="mi">6</span><span class="w">  </span><span class="nx">call_function</span><span class="w"> </span><span class="p">(</span><span class="nx">oparg</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">ffefb504700</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4370</span>
<span class="err">#</span><span class="mi">7</span><span class="w">  </span><span class="nx">PyEval_EvalFrameEx</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">2987</span>
<span class="err">#</span><span class="mi">8</span><span class="w">  </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">ca95f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">fast_function</span><span class="w"> </span><span class="p">(</span><span class="nx">nk</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">na</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">n</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">ffefb504850</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">func</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">f3e95f78c08</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4435</span>
<span class="err">#</span><span class="mi">9</span><span class="w">  </span><span class="nx">call_function</span><span class="w"> </span><span class="p">(</span><span class="nx">oparg</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">pp_stack</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">ffefb504850</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">4370</span>
<span class="err">#</span><span class="mi">10</span><span class="w"> </span><span class="nx">PyEval_EvalFrameEx</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">2987</span>
<span class="err">#</span><span class="mi">11</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">c32e5</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyEval_EvalCodeEx</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">3582</span>
<span class="err">#</span><span class="mi">12</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">c3089</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyEval_EvalCode</span><span class="w"> </span><span class="p">(</span><span class="nx">co</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">globals</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">locals</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">ceval</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">669</span>
<span class="err">#</span><span class="mi">13</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">f263f</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">run_mod</span><span class="p">.</span><span class="nx">lto_priv</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">pythonrun</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">1376</span>
<span class="err">#</span><span class="mi">14</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">ecf52</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyRun_FileExFlags</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">pythonrun</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">1362</span>
<span class="err">#</span><span class="mi">15</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0000000004</span><span class="nx">eb6d1</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">PyRun_SimpleFileExFlags</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Python</span><span class="o">/</span><span class="nx">pythonrun</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">948</span>
<span class="err">#</span><span class="mi">16</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">00000000049</span><span class="nx">e2d8</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">Py_Main</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="nx">Modules</span><span class="o">/</span><span class="nx">main</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">640</span>
<span class="err">#</span><span class="mi">17</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">0007</span><span class="nx">f3e94fc2610</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">__libc_start_main</span><span class="w"> </span><span class="p">(</span><span class="nx">main</span><span class="p">=</span><span class="mh">0x4</span><span class="mi">9</span><span class="nx">dc00</span><span class="w"> </span><span class="p">&lt;</span><span class="nx">main</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">argc</span><span class="p">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">argv</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">ffefb504c98</span><span class="p">,</span><span class="w"> </span><span class="nx">init</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">fini</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">rtld_fini</span><span class="p">=&lt;</span><span class="nx">optimized</span><span class="w"> </span><span class="nx">out</span><span class="p">&gt;,</span><span class="w"> </span><span class="nx">stack_end</span><span class="p">=</span><span class="mh">0x7</span><span class="nx">ffefb504c88</span><span class="p">)</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">libc</span><span class="o">-</span><span class="nx">start</span><span class="p">.</span><span class="nx">c</span><span class="p">:</span><span class="mi">291</span>
<span class="err">#</span><span class="mi">18</span><span class="w"> </span><span class="mh">0x0</span><span class="mi">00000000049</span><span class="nx">db29</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">_start</span><span class="w"> </span><span class="p">()</span>

<span class="p">(</span><span class="nx">gdb</span><span class="p">)</span><span class="w"> </span><span class="nx">py</span><span class="o">-</span><span class="nx">bt</span>

<span class="nx">Undefined</span><span class="w"> </span><span class="nx">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;py-bt&quot;</span><span class="p">.</span><span class="w">  </span><span class="nx">Try</span><span class="w"> </span><span class="s">&quot;help&quot;</span><span class="p">.</span>
</code></pre></div>

<p>Once again, this is caused by the fact that <code>python</code> binary in a virtual
environment has a different path. By default, <code>gdb</code> will try to <a href="https://sourceware.org/gdb/onlinedocs/gdb/Python-Auto_002dloading.html#set%20auto%2dload%20python%2dscripts">auto-load</a>
Python extensions for a particular object file under debug, if they exist.
Specifically, <code>gdb</code> will look for <code>objfile-gdb.py</code> and try to <code>source</code> it on
start:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="nb">load</span>

<span class="n">gdb</span><span class="o">-</span><span class="n">scripts</span><span class="p">:</span><span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="nb">load</span><span class="w"> </span><span class="n">scripts</span><span class="o">.</span>
<span class="n">libthread</span><span class="o">-</span><span class="n">db</span><span class="p">:</span><span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="n">loaded</span><span class="w"> </span><span class="n">libthread</span><span class="o">-</span><span class="n">db</span><span class="o">.</span>
<span class="n">local</span><span class="o">-</span><span class="n">gdbinit</span><span class="p">:</span><span class="w">  </span><span class="n">Local</span><span class="w"> </span><span class="o">.</span><span class="n">gdbinit</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">found</span><span class="o">.</span>
<span class="n">python</span><span class="o">-</span><span class="n">scripts</span><span class="p">:</span>
<span class="n">Loaded</span><span class="w">  </span><span class="n">Script</span>
<span class="n">Yes</span><span class="w">     </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">gdb</span><span class="o">/</span><span class="n">auto</span><span class="o">-</span><span class="nb">load</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span><span class="o">-</span><span class="n">gdb</span><span class="o">.</span><span class="n">py</span>
</code></pre></div>

<p>If, for some reason this has not been done, you can always do it manually:</p>
<div class="codehilite"><pre><span></span><code><span class="p">(</span><span class="n">gdb</span><span class="p">)</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">gdb</span><span class="o">/</span><span class="n">auto</span><span class="o">-</span><span class="nb">load</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span><span class="o">-</span><span class="n">gdb</span><span class="o">.</span><span class="n">py</span>
</code></pre></div>

<p>e.g. if you want to test a new version of the <code>gdb</code> extension shipped with CPython.</p>
<h2>PyPy, Jython, etc</h2>
<p>The described debugging technique is only feasible for the CPython interpreter
as is, as the <code>gdb</code> extension is specifically written to introspect the state
of CPython internals (e.g. <code>PyEval_EvalFrameEx</code> calls).</p>
<p>For <a href="http://pypy.org/">PyPy</a> there is an open <a href="https://bitbucket.org/pypy/pypy/issues/1204/gdb-hooks-for-debugging-pypy">issue</a> on Bitbucket, where it was proposed to
provide integration with <code>gdb</code>, but looks like the attached patches have not
been merged yet and the person, who wrote those, lost interest in this.</p>
<p>For <a href="http://www.jython.org/">Jython</a> you could probably use standard tools for debugging of <code>JVM</code>
applications, e.g. <a href="http://visualvm.java.net/">VisualVM</a>.</p>
<h2>Conclusion</h2>
<p><code>gdb</code> is a powerful tool, that allows one to debug complex problems with
crashing or hanging CPython processes, as well as Python code, that does
calls to native libraries. On modern Linux distros debugging CPython processes
with <code>gdb</code> must be as simple as installing of debugging symbols for the
concrete interpreter build, although there are a few known gotchas, especially
when virtual environments are used.</p>

  <footer>
  
  
  </footer>
</article>

  </div> <!-- /#content -->
  </div> <!-- /.content-wrapper -->

  <div class="footer-wrapper">
  <footer class="footer">
    <p>&copy; 2023 Roman Podoliaka
</p>
  </footer>
  </div> <!-- /.footer-wrapper -->

  



<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37812430-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- /Google Analytics -->